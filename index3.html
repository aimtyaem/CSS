<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSS: Interactive Air Quality & Safety Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      scrollbar-width: thin;
      scrollbar-color: #4fc3f7 #162b3e;
    }
    body::-webkit-scrollbar {
      width: 8px;
    }
    body::-webkit-scrollbar-track {
      background: #162b3e;
    }
    body::-webkit-scrollbar-thumb {
      background-color: #4fc3f7;
      border-radius: 10px;
      border: 2px solid #162b3e;
    }
    :root {
      --primary: #0c1b2e;
      --secondary: #162b3e;
      --accent: #4fc3f7;
      --danger: #f44336;
      --warning: #ffc107;
      --success: #4caf50;
      --text: #ffffff;
      --text-secondary: #a0c4e0;
      --card-bg: rgba(22, 43, 62, 0.9);
      --border: rgba(255, 255, 255, 0.1);
    }
    .high-contrast {
      --primary: #000000;
      --secondary: #1a1a1a;
      --accent: #00ffff;
      --danger: #ff1a1a;
      --warning: #ffff1a;
      --success: #1aff1a;
      --text: #ffffff;
      --text-secondary: #e6e6e6;
      --card-bg: rgba(10, 10, 10, 0.95);
      --border: rgba(255, 255, 255, 0.4);
    }
    .leaflet-tile-pane {
      filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
    }
    .tab-btn.active {
      background-color: var(--accent);
      color: var(--primary);
      font-weight: 600;
    }
    .pollutant-item.active {
      background-color: rgba(79, 195, 247, 0.15);
      border-left: 3px solid var(--accent);
      padding-left: 10px;
    }
    #sidebar {
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .leaflet-popup-content-wrapper {
        background: var(--card-bg);
        color: var(--text);
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.4);
    }
    .leaflet-popup-content {
        margin: 15px;
    }
    .leaflet-popup-tip {
        background: var(--card-bg);
    }
    .model-item, .timeframe-item {
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 5px;
    }
    .model-item:hover, .timeframe-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    .model-item.active, .timeframe-item.active {
      background-color: rgba(79, 195, 247, 0.2);
      border-left: 3px solid var(--accent);
    }
    .collapsed .pollutant-text, .collapsed .model-text, .collapsed .timeframe-text {
      display: none;
    }
    .collapsed .pollutant-item {
      justify-content: center;
      padding-left: 0;
    }
    .collapsed .pollutant-item.active {
      padding-left: 0;
      border-left: none;
      background-color: rgba(79, 195, 247, 0.3);
      border-radius: 8px;
    }
    .collapsed .section-title {
      display: none;
    }
    .layer-controls {
      position: absolute;
      top: 80px;
      right: 20px;
      background: rgba(22, 43, 62, 0.9);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
    }
    .layer-controls button {
      margin: 5px;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }
    .layer-controls button.active {
      background: rgba(79, 195, 247, 0.3);
    }
  </style>
</head>
<body class="bg-gray-900 text-white antialiased">
  
  <div id="app" class="flex h-screen overflow-hidden bg-gradient-to-br from-[#0c1b2e] to-[#162b3e]">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-16 bg-[rgba(22,43,62,0.8)] backdrop-blur-sm border-r border-[rgba(255,255,255,0.1)] flex flex-col z-20 collapsed">
      <!-- Logo and Collapse Button -->
      <div class="flex items-center justify-between p-4 border-b border-[rgba(255,255,255,0.1)]">
        <div class="flex items-center space-x-3">
          <i class="fas fa-wind text-2xl text-[#4fc3f7]"></i>
          <div id="logo-text" class="hidden">
            <h1 class="text-lg font-bold text-[#4fc3f7]">CSS</h1>
            <p class="text-xs text-gray-400">Safer Sites</p>
          </div>
        </div>
        <button id="collapseBtn" class="p-2 rounded-full hover:bg-white/10 focus:outline-none">
          <i id="collapseIcon" class="fas fa-chevron-right transition-transform duration-300"></i>
        </button>
      </div>
      
      <!-- Search -->
      <div class="p-4 hidden">
        <div class="relative">
          <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input id="searchInput" type="text" placeholder="Search locations..." class="w-full bg-black/20 border border-white/10 rounded-lg pl-10 pr-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#4fc3f7]">
          <div id="searchResults" class="absolute top-full left-0 right-0 mt-1 bg-[#162b3e] border border-white/10 rounded-lg max-h-60 overflow-y-auto z-30 hidden"></div>
        </div>
      </div>
      
      <!-- Pollutants List -->
      <div class="p-4 border-b border-[rgba(255,255,255,0.1)]">
        <h2 class="text-sm font-semibold text-[#4fc3f7] mb-3 flex items-center section-title"><i class="fas fa-smog mr-2"></i><span class="sidebar-text">Pollutants</span></h2>
        <ul id="pollutantsList" class="space-y-2">
            <!-- Pollutant items will be dynamically inserted here -->
        </ul>
      </div>

      <!-- Prediction Model -->
      <div class="p-4 border-b border-[rgba(255,255,255,0.1)]">
        <h2 class="text-sm font-semibold text-[#4fc3f7] mb-3 flex items-center section-title"><i class="fas fa-chart-line mr-2"></i><span class="sidebar-text">Prediction Model</span></h2>
        <div id="predictionModels" class="space-y-1">
          <div class="model-item active flex items-center" data-model="cams">
            <i class="fas fa-globe w-6 text-center text-[#4fc3f7]"></i>
            <span class="model-text ml-2">CAMS Global</span>
          </div>
          <div class="model-item flex items-center" data-model="geds">
            <i class="fas fa-chart-bar w-6 text-center text-[#4fc3f7]"></i>
            <span class="model-text ml-2">GEDS-CF</span>
          </div>
        </div>
      </div>

      <!-- Timeframe -->
      <div class="p-4 border-b border-[rgba(255,255,255,0.1)]">
        <h2 class="text-sm font-semibold text-[#4fc3f7] mb-3 flex items-center section-title"><i class="far fa-clock mr-2"></i><span class="sidebar-text">Timeframe</span></h2>
        <div id="timeframeOptions" class="space-y-1">
          <div class="timeframe-item active flex items-center" data-timeframe="new">
            <i class="fas fa-plus w-6 text-center text-[#4fc3f7]"></i>
            <span class="timeframe-text ml-2">New</span>
          </div>
          <div class="timeframe-item flex items-center" data-timeframe="settings">
            <i class="fas fa-cog w-6 text-center text-[#4fc3f7]"></i>
            <span class="timeframe-text ml-2">Settings</span>
          </div>
          <div class="timeframe-item flex items-center" data-timeframe="help">
            <i class="fas fa-question-circle w-6 text-center text-[#4fc3f7]"></i>
            <span class="timeframe-text ml-2">Help</span>
          </div>
        </div>
      </div>

      <!-- Settings and Controls -->
      <div class="p-4 mt-auto">
         <h2 class="text-sm font-semibold text-[#4fc3f7] mb-3 flex items-center section-title"><i class="fas fa-tools mr-2"></i><span class="sidebar-text">Controls</span></h2>
         <div class="sidebar-text space-y-3 hidden">
             <div>
                <label for="dataSource" class="block text-xs text-gray-400 mb-1">Data Source</label>
                <select id="dataSource" class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#4fc3f7]">
                  <option value="waqi">World Air Quality Index</option>
                  <option value="openweather">OpenWeather Map</option>
                </select>
             </div>
             <div>
                <label for="mapType" class="block text-xs text-gray-400 mb-1">Map Display</label>
                <select id="mapType" class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#4fc3f7]">
                  <option value="heatmap">Heatmap</option>
                  <option value="markers">Markers</option>
                </select>
             </div>
         </div>
         <div class="mt-4 flex space-x-2">
             <button id="contrastToggle" class="w-full flex items-center justify-center space-x-2 bg-black/20 p-2 rounded-lg text-sm hover:bg-white/10">
               <i class="fas fa-adjust"></i>
               <span class="sidebar-text hidden">Contrast</span>
             </button>
             <button id="textSizeToggle" class="w-full flex items-center justify-center space-x-2 bg-black/20 p-2 rounded-lg text-sm hover:bg-white/10">
               <i class="fas fa-text-height"></i>
               <span class="sidebar-text hidden">Text</span>
             </button>
         </div>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative">
      <header class="flex items-center justify-between p-4 bg-black/10">
        <h2 class="text-xl font-bold">CSS: Air Quality & Safety Prediction Map</h2>
        <div class="flex items-center space-x-4">
          <div class="text-sm text-gray-300"><i class="far fa-calendar-alt mr-2"></i><span id="currentDate"></span></div>
          <button id="locateMe" class="p-2 rounded-full hover:bg-white/10" title="Locate Me"><i class="fas fa-location-arrow"></i></button>
        </div>
      </header>
      
      <!-- Map Container -->
      <div id="map" class="flex-1"></div>
      
      <!-- Layer Controls -->
      <div class="layer-controls hidden" id="layerControls">
        <div class="text-sm font-semibold text-[#4fc3f7] mb-2">Active Layer</div>
        <div id="activeLayer" class="text-xs mb-2">None</div>
        <button id="clearLayers" class="w-full bg-red-500/20 hover:bg-red-500/30 text-red-300">Clear Layers</button>
      </div>
      
      <!-- Map Legend -->
      <div class="legend absolute bottom-5 left-5 bg-[rgba(22,43,62,0.8)] backdrop-blur-sm p-3 rounded-lg border border-white/10 shadow-lg z-10 w-64">
        <div id="legendTitle" class="font-bold text-sm text-[#4fc3f7] mb-2">PM2.5 Concentration (µg/m³)</div>
        <div class="w-full h-2 rounded-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 mb-1"></div>
        <div class="flex justify-between text-xs text-gray-300">
          <span>0</span>
          <span>10</span>
          <span>100</span>
          <span>200</span>
        </div>
        <div class="mt-2 text-xs text-gray-300">
          <div>Potential Hazards</div>
          <div>Tats Pension Nord</div>
        </div>
      </div>

      <!-- Location Card -->
      <div id="locationCard" class="absolute top-20 left-5 bg-[rgba(22,43,62,0.8)] backdrop-blur-sm w-96 max-w-[90vw] rounded-lg border border-white/10 shadow-2xl z-10 hidden transform transition-all duration-300">
        <!-- Card Header -->
        <div class="flex items-center justify-between p-3 border-b border-white/10">
          <div>
            <h3 id="cardCity" class="font-bold text-lg text-[#4fc3f7]">Loading...</h3>
            <p id="cardCountry" class="text-sm text-gray-400">Fetching data...</p>
          </div>
          <button id="cardClose" class="p-2 rounded-full hover:bg-white/10"><i class="fas fa-times"></i></button>
        </div>
        
        <!-- Card Tabs -->
        <div class="flex bg-black/20 p-1">
          <button class="tab-btn flex-1 py-2 text-sm rounded-md active" data-tab="current">Current</button>
          <button class="tab-btn flex-1 py-2 text-sm rounded-md" data-tab="history">History</button>
          <button class="tab-btn flex-1 py-2 text-sm rounded-md" data-tab="forecast">Forecast</button>
        </div>
        
        <!-- Card Content -->
        <div class="p-4">
          <!-- Current Conditions Tab -->
          <div id="current-tab" class="tab-content">
              <div class="text-center mb-4">
                  <p class="text-sm text-gray-400">Air Quality Index (AQI)</p>
                  <div id="cardAqi" class="text-5xl font-bold my-1">--</div>
                  <div id="cardStatus" class="inline-block px-3 py-1 text-sm rounded-full font-semibold">--</div>
              </div>
              <div id="pollutantDetails" class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                  <!-- Pollutant details will be dynamically inserted here -->
              </div>
               <p id="cardRecommendations" class="mt-4 text-xs text-center text-gray-300 bg-black/20 p-2 rounded-md"></p>
          </div>

          <!-- History Tab -->
          <div id="history-tab" class="tab-content hidden">
            <h4 class="text-sm font-semibold text-center mb-2">Last 24 Hours AQI</h4>
            <canvas id="historyChart" class="w-full h-48"></canvas>
          </div>

          <!-- Forecast Tab -->
          <div id="forecast-tab" class="tab-content hidden">
              <h4 class="text-sm font-semibold text-center mb-2">7-Day AQI Forecast</h4>
              <div id="forecast-list" class="space-y-2 text-sm">
                  <!-- Forecast items will be dynamically inserted here -->
              </div>
          </div>
        </div>
        <div id="cardUpdated" class="px-4 pb-3 text-xs text-center text-gray-500"></div>
      </div>

      <!-- Nested Pages -->
      <!-- Settings Page -->
      <div id="settingsPage" class="absolute inset-0 bg-[rgba(22,43,62,0.95)] backdrop-blur-sm z-30 hidden transform transition-all duration-300">
        <div class="flex flex-col h-full">
          <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h2 class="text-xl font-bold text-[#4fc3f7]">CSS Settings</h2>
            <button id="closeSettings" class="p-2 rounded-full hover:bg-white/10"><i class="fas fa-times"></i></button>
          </div>
          <div class="flex-1 p-6 overflow-y-auto">
            <div class="max-w-2xl mx-auto space-y-6">
              <div class="bg-black/20 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Appearance</h3>
                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <span>Dark Mode</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="darkModeToggle" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-700 peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>High Contrast</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="contrastToggleSetting" class="sr-only peer">
                      <div class="w-11 h-6 bg-gray-700 peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>Sidebar Auto-Collapse</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="autoCollapseToggle" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-700 peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="bg-black/20 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Notifications</h3>
                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <span>AQI Alerts</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="aqiAlertsToggle" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-700 peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>Hazard Warnings</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="hazardWarningsToggle" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-700 peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                  </div>
                </div>
              </div>
              
              <div class="bg-black/20 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3">Map Settings</h3>
                <div class="space-y-3">
                  <div>
                    <label for="defaultLayer" class="block text-sm mb-2">Default Map Layer</label>
                    <select id="defaultLayer" class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#4fc3f7]">
                      <option value="none">None (Base Map)</option>
                      <option value="pm25">PM2.5</option>
                      <option value="o3">Ozone</option>
                      <option value="no2">Nitrogen Dioxide</option>
                      <option value="so2">Sulfur Dioxide</option>
                    </select>
                  </div>
                  <div class="flex items-center justify-between">
                    <span>Auto-refresh Data</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="autoRefreshToggle" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-700 peer-focus:ring-4 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Help Page -->
      <div id="helpPage" class="absolute inset-0 bg-[rgba(22,43,62,0.95)] backdrop-blur-sm z-30 hidden transform transition-all duration-300">
        <div class="flex flex-col h-full">
          <div class="flex items-center justify-between p-4 border-b border-white/10">
            <h2 class="text-xl font-bold text-[#4fc3f7]">CSS Help & Information</h2>
            <button id="closeHelp" class="p-2 rounded-full hover:bg-white/10"><i class="fas fa-times"></i></button>
          </div>
          <div class="flex-1 p-6 overflow-y-auto">
            <div class="max-w-3xl mx-auto space-y-6">
              <div class="bg-black/20 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-[#4fc3f7]">Using the CSS Map</h3>
                <p class="text-gray-300 mb-2">The CSS (Cloener Safer Sites) interactive map displays real-time air quality data from various monitoring stations around the world.</p>
                <ul class="list-disc pl-5 text-gray-300 space-y-1">
                  <li>Click on any marker to view detailed air quality information</li>
                  <li>Use the pollutant icons in the sidebar to toggle different data layers</li>
                  <li>Click the clear layers button to return to the base map view</li>
                  <li>Use the locate button to center the map on your current position</li>
                </ul>
              </div>
              
              <div class="bg-black/20 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-[#4fc3f7]">Understanding AQI</h3>
                <p class="text-gray-300 mb-2">The Air Quality Index (AQI) is a standardized indicator of air quality:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                  <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-green-500 mr-2"></div>
                    <span>0-50: Good</span>
                  </div>
                  <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-yellow-500 mr-2"></div>
                    <span>51-100: Moderate</span>
                  </div>
                  <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-orange-500 mr-2"></div>
                    <span>101-150: Unhealthy for Sensitive Groups</span>
                  </div>
                  <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-red-500 mr-2"></div>
                    <span>151-200: Unhealthy</span>
                  </div>
                  <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-purple-500 mr-2"></div>
                    <span>201-300: Very Unhealthy</span>
                  </div>
                  <div class="flex items-center">
                    <div class="w-4 h-4 rounded-full bg-maroon-500 mr-2"></div>
                    <span>301+: Hazardous</span>
                  </div>
                </div>
              </div>
              
              <div class="bg-black/20 p-4 rounded-lg">
                <h3 class="text-lg font-semibold mb-3 text-[#4fc3f7]">Pollutants Monitored</h3>
                <div class="space-y-3">
                  <div>
                    <h4 class="font-medium text-[#4fc3f7]">PM2.5 (Particulate Matter 2.5)</h4>
                    <p class="text-gray-300 text-sm">Fine inhalable particles with diameters that are generally 2.5 micrometers and smaller.</p>
                  </div>
                  <div>
                    <h4 class="font-medium text-[#4fc3f7]">O₃ (Ozone)</h4>
                    <p class="text-gray-300 text-sm">A gas that occurs both in the Earth's upper atmosphere and at ground level.</p>
                  </div>
                  <div>
                    <h4 class="font-medium text-[#4fc3f7]">NO₂ (Nitrogen Dioxide)</h4>
                    <p class="text-gray-300 text-sm">A reddish-brown gas with a characteristic sharp, biting odor.</p>
                  </div>
                  <div>
                    <h4 class="font-medium text-[#4fc3f7]">SO₂ (Sulfur Dioxide)</h4>
                    <p class="text-gray-300 text-sm">A toxic gas with a pungent, irritating smell.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- STATE MANAGEMENT ---
      let map;
      let heatmapLayer;
      let markerLayer = L.layerGroup();
      let activePollutant = null;
      let historyChart;
      const cachedData = {};
      const apiBaseUrl = '/api/air-quality';
      let settings = {
        darkMode: true,
        highContrast: false,
        autoCollapse: true,
        aqiAlerts: true,
        hazardWarnings: true,
        defaultLayer: 'none',
        autoRefresh: true
      };

      // --- DOM ELEMENTS ---
      const elements = {
        sidebar: document.getElementById('sidebar'),
        collapseBtn: document.getElementById('collapseBtn'),
        collapseIcon: document.getElementById('collapseIcon'),
        logoText: document.getElementById('logo-text'),
        sidebarTexts: document.querySelectorAll('.sidebar-text'),
        pollutantsList: document.getElementById('pollutantsList'),
        mapTypeSelect: document.getElementById('mapType'),
        locationCard: document.getElementById('locationCard'),
        cardClose: document.getElementById('cardClose'),
        searchInput: document.getElementById('searchInput'),
        searchResults: document.getElementById('searchResults'),
        locateMeBtn: document.getElementById('locateMe'),
        currentDateEl: document.getElementById('currentDate'),
        contrastToggle: document.getElementById('contrastToggle'),
        textSizeToggle: document.getElementById('textSizeToggle'),
        settingsPage: document.getElementById('settingsPage'),
        closeSettings: document.getElementById('closeSettings'),
        helpPage: document.getElementById('helpPage'),
        closeHelp: document.getElementById('closeHelp'),
        predictionModels: document.getElementById('predictionModels'),
        timeframeOptions: document.getElementById('timeframeOptions'),
        layerControls: document.getElementById('layerControls'),
        clearLayers: document.getElementById('clearLayers'),
        activeLayer: document.getElementById('activeLayer'),
        // Settings toggles
        darkModeToggle: document.getElementById('darkModeToggle'),
        contrastToggleSetting: document.getElementById('contrastToggleSetting'),
        autoCollapseToggle: document.getElementById('autoCollapseToggle'),
        aqiAlertsToggle: document.getElementById('aqiAlertsToggle'),
        hazardWarningsToggle: document.getElementById('hazardWarningsToggle'),
        defaultLayer: document.getElementById('defaultLayer'),
        autoRefreshToggle: document.getElementById('autoRefreshToggle')
      };

      // --- INITIALIZATION ---
      function initializeApp() {
        initMap();
        initEventListeners();
        updateDateTime();
        setInterval(updateDateTime, 60000);
        populatePollutants();
        fetchInitialData();
        loadSettings();
      }

      function initMap() {
        map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            zoomControl: false
        });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        heatmapLayer = L.heatLayer([], {
          radius: 25,
          blur: 15, 
          maxZoom: 11,
          max: 200,
          gradient: { 0.4: 'green', 0.65: 'yellow', 1: 'red' }
        });
        
        markerLayer.addTo(map);
        
        // Initially show only the base map without any layers
        map.removeLayer(heatmapLayer);
        map.removeLayer(markerLayer);

        map.on('click', onMapClick);
        map.on('moveend', fetchViewportData);
      }

      function initEventListeners() {
        elements.collapseBtn.addEventListener('click', toggleSidebar);
        elements.mapTypeSelect.addEventListener('change', toggleMapDisplay);
        elements.cardClose.addEventListener('click', () => hideElement(elements.locationCard));
        elements.searchInput.addEventListener('input', handleSearch);
        elements.locateMeBtn.addEventListener('click', locateUser);
        elements.contrastToggle.addEventListener('click', toggleContrast);
        elements.textSizeToggle.addEventListener('click', toggleTextSize);
        
        // New event listeners for nested pages
        elements.closeSettings.addEventListener('click', () => hideElement(elements.settingsPage));
        elements.closeHelp.addEventListener('click', () => hideElement(elements.helpPage));
        
        // Layer controls
        elements.clearLayers.addEventListener('click', clearActiveLayers);

        // Event listeners for prediction models
        elements.predictionModels.addEventListener('click', (e) => {
          const item = e.target.closest('.model-item');
          if(item) {
            document.querySelectorAll('.model-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            console.log(`Selected prediction model: ${item.dataset.model}`);
          }
        });

        // Event listeners for timeframe options
        elements.timeframeOptions.addEventListener('click', (e) => {
          const item = e.target.closest('.timeframe-item');
          if(item) {
            const timeframe = item.dataset.timeframe;
            if(timeframe === 'settings') {
              showElement(elements.settingsPage);
              updateSettingsUI();
            } else if(timeframe === 'help') {
              showElement(elements.helpPage);
            } else if(timeframe === 'new') {
              // Handle "New" timeframe selection
              document.querySelectorAll('.timeframe-item').forEach(i => i.classList.remove('active'));
              item.classList.add('active');
              console.log('Selected timeframe: New');
            }
          }
        });

        // Settings event listeners
        elements.darkModeToggle.addEventListener('change', (e) => {
          settings.darkMode = e.target.checked;
          applySettings();
        });
        elements.contrastToggleSetting.addEventListener('change', (e) => {
          settings.highContrast = e.target.checked;
          applySettings();
        });
        elements.autoCollapseToggle.addEventListener('change', (e) => {
          settings.autoCollapse = e.target.checked;
          applySettings();
        });
        elements.aqiAlertsToggle.addEventListener('change', (e) => {
          settings.aqiAlerts = e.target.checked;
          applySettings();
        });
        elements.hazardWarningsToggle.addEventListener('change', (e) => {
          settings.hazardWarnings = e.target.checked;
          applySettings();
        });
        elements.defaultLayer.addEventListener('change', (e) => {
          settings.defaultLayer = e.target.value;
          applySettings();
        });
        elements.autoRefreshToggle.addEventListener('change', (e) => {
          settings.autoRefresh = e.target.checked;
          applySettings();
        });

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(`${tab}-tab`).classList.remove('hidden');
            });
        });

        elements.pollutantsList.addEventListener('click', (e) => {
            const item = e.target.closest('.pollutant-item');
            if(item) {
                const pollutant = item.dataset.pollutant;
                
                // Toggle behavior: if already active, deactivate it
                if (activePollutant === pollutant) {
                  item.classList.remove('active');
                  activePollutant = null;
                  clearActiveLayers();
                } else {
                  document.querySelectorAll('.pollutant-item').forEach(i => i.classList.remove('active'));
                  item.classList.add('active');
                  activePollutant = pollutant;
                  updateMapVisualization();
                  showElement(elements.layerControls);
                  elements.activeLayer.textContent = item.querySelector('strong').textContent;
                }
                
                // Auto-collapse sidebar if setting is enabled
                if (settings.autoCollapse && !elements.sidebar.classList.contains('collapsed')) {
                  toggleSidebar();
                }
            }
        });
      }
      
      // --- UI & INTERACTIONS ---

      function toggleSidebar() {
          const isCollapsed = elements.sidebar.classList.toggle('collapsed');
          elements.sidebar.classList.toggle('w-80');
          elements.sidebar.classList.toggle('w-16');
          elements.collapseIcon.classList.toggle('fa-chevron-right');
          elements.collapseIcon.classList.toggle('fa-chevron-left');
          elements.logoText.classList.toggle('hidden');
          
          // Toggle visibility of text elements
          document.querySelectorAll('.sidebar-text').forEach(el => el.classList.toggle('hidden'));
          document.querySelectorAll('.section-title').forEach(el => el.classList.toggle('hidden'));
          document.querySelectorAll('.model-text').forEach(el => el.classList.toggle('hidden'));
          document.querySelectorAll('.timeframe-text').forEach(el => el.classList.toggle('hidden'));
          document.querySelectorAll('.pollutant-text').forEach(el => el.classList.toggle('hidden'));
          
          // Toggle search bar visibility
          document.querySelector('.p-4.hidden').classList.toggle('hidden');
      }
      
      function toggleMapDisplay(e) {
          if (e.target.value === 'heatmap') {
              map.addLayer(heatmapLayer);
              map.removeLayer(markerLayer);
          } else {
              map.removeLayer(heatmapLayer);
              map.addLayer(markerLayer);
          }
      }

      function updateDateTime() {
          elements.currentDateEl.textContent = new Date().toLocaleString('en-US', {
              weekday: 'long', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
          }) + ' UTC';
      }

      function populatePollutants() {
          const pollutants = [
              { id: 'pm25', name: 'PM2.5', unit: 'µg/m³', icon: 'fa-wind' },
              { id: 'o3', name: 'Ozone (O₃)', unit: 'µg/m³', icon: 'fa-cloud' },
              { id: 'no2', name: 'NO₂', unit: 'µg/m³', icon: 'fa-industry' },
              { id: 'so2', name: 'SO₂', unit: 'µg/m³', icon: 'fa-smog' },
          ];
          elements.pollutantsList.innerHTML = pollutants.map(p => `
              <li class="pollutant-item flex items-center p-2 rounded-md cursor-pointer hover:bg-white/5" data-pollutant="${p.id}" data-unit="${p.unit}">
                  <i class="fas ${p.icon} w-6 text-center text-[#4fc3f7]"></i>
                  <div class="pollutant-text ml-2">
                      <strong>${p.name}</strong>
                      <p class="text-xs text-gray-400">View on Map</p>
                  </div>
              </li>
          `).join('');
      }

      const showElement = (el) => el.classList.remove('hidden');
      const hideElement = (el) => el.classList.add('hidden');

      // --- SETTINGS MANAGEMENT ---
      function loadSettings() {
        const savedSettings = localStorage.getItem('css-settings');
        if (savedSettings) {
          settings = { ...settings, ...JSON.parse(savedSettings) };
        }
        applySettings();
      }

      function saveSettings() {
        localStorage.setItem('css-settings', JSON.stringify(settings));
      }

      function updateSettingsUI() {
        elements.darkModeToggle.checked = settings.darkMode;
        elements.contrastToggleSetting.checked = settings.highContrast;
        elements.autoCollapseToggle.checked = settings.autoCollapse;
        elements.aqiAlertsToggle.checked = settings.aqiAlerts;
        elements.hazardWarningsToggle.checked = settings.hazardWarnings;
        elements.defaultLayer.value = settings.defaultLayer;
        elements.autoRefreshToggle.checked = settings.autoRefresh;
      }

      function applySettings() {
        // Apply dark mode
        if (settings.darkMode) {
          document.body.classList.remove('bg-white', 'text-gray-900');
          document.body.classList.add('bg-gray-900', 'text-white');
        } else {
          document.body.classList.remove('bg-gray-900', 'text-white');
          document.body.classList.add('bg-white', 'text-gray-900');
        }
        
        // Apply high contrast
        if (settings.highContrast) {
          document.body.classList.add('high-contrast');
        } else {
          document.body.classList.remove('high-contrast');
        }
        
        // Apply default layer
        if (settings.defaultLayer !== 'none' && !activePollutant) {
          const pollutantItem = document.querySelector(`[data-pollutant="${settings.defaultLayer}"]`);
          if (pollutantItem) {
            pollutantItem.click();
          }
        }
        
        saveSettings();
      }

      function toggleContrast() {
        settings.highContrast = !settings.highContrast;
        applySettings();
      }

      function toggleTextSize() {
        document.body.classList.toggle('text-lg');
      }

      // --- DATA FETCHING & HANDLING ---
      async function fetchData(lat, lng) {
        const cacheKey = `${lat.toFixed(2)},${lng.toFixed(2)}`;
        if (cachedData[cacheKey]) return cachedData[cacheKey];

        try {
            const data = generateMockData(lat, lng);
            cachedData[cacheKey] = data;
            return data;
        } catch (error) {
            console.error("Failed to fetch data:", error);
            return null;
        }
      }

      function fetchInitialData() {
          const initialCities = [
              { lat: 30.04, lng: 31.23 }, { lat: 51.50, lng: -0.12 }, 
              { lat: 40.71, lng: -74.00 }, { lat: 35.67, lng: 139.65 },
              { lat: 28.61, lng: 77.20 }, { lat: 39.90, lng: 116.40 }
          ];
          initialCities.forEach(city => fetchData(city.lat, city.lng).then(processApiData));
      }

      function fetchViewportData() {
        const bounds = map.getBounds();
        const center = bounds.getCenter();
        fetchData(center.lat, center.lng).then(processApiData);
      }

      function processApiData(data) {
          if (!data) return;
          const { lat, lng, aqi } = data.current;
          const heatPoint = [lat, lng, aqi / 300];
          heatmapLayer.addLatLng(heatPoint);

          const marker = createMarker(data);
          markerLayer.addLayer(marker);
      }
      
      function updateMapVisualization() {
          const heatData = [];
          markerLayer.clearLayers();

          Object.values(cachedData).forEach(data => {
              const value = data.current.pollutants[activePollutant] || data.current.aqi;
              let intensity = 0;
              if (activePollutant === 'pm25') intensity = value / 100;
              else if (activePollutant === 'o3') intensity = value / 200;
              else if (activePollutant === 'no2') intensity = value / 100;
              else if (activePollutant === 'so2') intensity = value / 50;
              
              heatData.push([data.current.lat, data.current.lng, intensity]);
              
              const marker = createMarker(data);
              markerLayer.addLayer(marker);
          });
          
          heatmapLayer.setLatLngs(heatData);
          map.addLayer(heatmapLayer);
          map.addLayer(markerLayer);
      }
      
      function clearActiveLayers() {
        activePollutant = null;
        document.querySelectorAll('.pollutant-item').forEach(i => i.classList.remove('active'));
        map.removeLayer(heatmapLayer);
        map.removeLayer(markerLayer);
        hideElement(elements.layerControls);
      }
      
      // --- API MOCKUP ---
      function generateMockData(lat, lng) {
        const baseAqi = Math.floor(Math.abs(Math.sin(lat) * 150 + Math.cos(lng) * 150));
        const current = {
            aqi: baseAqi,
            lat, lng,
            city: `City at ${lat.toFixed(2)}°, ${lng.toFixed(2)}°`,
            country: 'Earth',
            status: getAqiStatus(baseAqi).text,
            recommendation: getHealthRecommendations(baseAqi),
            pollutants: {
                pm25: Math.round(baseAqi * 0.7),
                o3: Math.round(baseAqi * 0.5),
                no2: Math.round(baseAqi * 0.3),
                so2: Math.round(baseAqi * 0.2),
            },
            updated: new Date().toISOString()
        };

        const history = Array.from({length: 24}, (_, i) => ({
            hour: 23 - i,
            aqi: Math.max(10, baseAqi + Math.floor(Math.sin(i) * 20 + (Math.random() - 0.5) * 30))
        }));

        const forecast = Array.from({length: 7}, (_, i) => {
             const d = new Date();
             d.setDate(d.getDate() + i + 1);
             return {
                day: d.toLocaleDateString('en-US', { weekday: 'short' }),
                aqi: Math.max(10, baseAqi + Math.floor(Math.cos(i) * 15 + (Math.random() - 0.5) * 25)),
             }
        });
        return { current, history, forecast };
      }

      // --- MAP INTERACTIONS ---
      function onMapClick(e) {
          fetchData(e.latlng.lat, e.latlng.lng).then(data => {
              if (data) {
                  updateLocationCard(data);
                  showElement(elements.locationCard);
                  map.flyTo([e.latlng.lat, e.latlng.lng], Math.max(map.getZoom(), 8));
              }
          });
      }

      function createMarker(data) {
          const { lat, lng, aqi, city } = data.current;
          const color = getAqiStatus(aqi).color;
          const icon = L.divIcon({
              className: 'custom-div-icon',
              html: `<div style="background-color:${color};" class="w-3 h-3 rounded-full border-2 border-white/80 shadow-md"></div>`,
              iconSize: [12, 12],
          });
          const marker = L.marker([lat, lng], { icon: icon });
          marker.bindPopup(`<strong>${city}</strong><br>AQI: ${aqi}`);
          marker.on('click', () => {
              updateLocationCard(data);
              showElement(elements.locationCard);
          });
          return marker;
      }

      function handleSearch(e) {
          const query = e.target.value;
          if (query.length < 3) {
              hideElement(elements.searchResults);
              return;
          }
          setTimeout(async () => {
              const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=5`);
              const results = await response.json();
              elements.searchResults.innerHTML = results.map(r => 
                  `<div class="p-2 cursor-pointer hover:bg-white/10 text-sm" data-lat="${r.lat}" data-lng="${r.lon}">${r.display_name}</div>`
              ).join('');
              showElement(elements.searchResults);
          }, 300);
      }
      
      elements.searchResults.addEventListener('click', (e) => {
          const item = e.target.closest('div');
          if (!item) return;
          const lat = parseFloat(item.dataset.lat);
          const lng = parseFloat(item.dataset.lng);
          onMapClick({ latlng: { lat, lng } });
          hideElement(elements.searchResults);
          elements.searchInput.value = '';
      });

      function locateUser() {
        navigator.geolocation.getCurrentPosition(pos => {
            onMapClick({ latlng: { lat: pos.coords.latitude, lng: pos.coords.longitude }});
        }, () => alert("Could not get your location."));
      }

      // --- LOCATION CARD LOGIC ---
      function updateLocationCard(data) {
          const { current, history, forecast } = data;
          document.getElementById('cardCity').textContent = current.city;
          document.getElementById('cardCountry').textContent = current.country;
          document.getElementById('cardAqi').textContent = current.aqi;
          
          const status = getAqiStatus(current.aqi);
          const statusEl = document.getElementById('cardStatus');
          statusEl.textContent = status.text;
          statusEl.style.backgroundColor = status.bgColor;
          statusEl.style.color = status.textColor;

          document.getElementById('pollutantDetails').innerHTML = Object.entries(current.pollutants)
            .map(([key, value]) => `
                <div class="flex justify-between items-center"><span class="text-gray-400 uppercase">${key}</span> <strong>${value} µg/m³</strong></div>
            `).join('');

          document.getElementById('cardRecommendations').textContent = current.recommendation;
          document.getElementById('cardUpdated').textContent = `Updated: ${new Date(current.updated).toLocaleTimeString()}`;

          updateHistoryChart(history);
          updateForecastList(forecast);
      }
      
      function updateHistoryChart(historyData) {
        const ctx = document.getElementById('historyChart').getContext('2d');
        const labels = historyData.map(h => `${h.hour}:00`).reverse();
        const data = historyData.map(h => h.aqi).reverse();

        if (historyChart) {
            historyChart.data.labels = labels;
            historyChart.data.datasets[0].data = data;
            historyChart.update();
        } else {
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'AQI',
                        data: data,
                        borderColor: '#4fc3f7',
                        backgroundColor: 'rgba(79, 195, 247, 0.2)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#a0c4e0', maxRotation: 0, autoSkip: true, maxTicksLimit: 6 }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#a0c4e0' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }
      }

      function updateForecastList(forecastData) {
          document.getElementById('forecast-list').innerHTML = forecastData.map(day => {
              const status = getAqiStatus(day.aqi);
              return `
                  <div class="flex items-center justify-between p-2 rounded-md bg-black/20">
                      <span class="font-semibold">${day.day}</span>
                      <div class="flex items-center space-x-2">
                          <span style="color: ${status.textColor};">${day.aqi}</span>
                          <div class="w-3 h-3 rounded-full" style="background-color: ${status.color};"></div>
                      </div>
                  </div>
              `;
          }).join('');
      }

      // --- UTILITY FUNCTIONS ---
      function getAqiStatus(aqi) {
          if (aqi <= 50) return { text: 'Good', color: '#4caf50', bgColor: 'rgba(76, 175, 80, 0.2)', textColor: '#4caf50'};
          if (aqi <= 100) return { text: 'Moderate', color: '#ffc107', bgColor: 'rgba(255, 193, 7, 0.2)', textColor: '#ffc107'};
          if (aqi <= 150) return { text: 'Unhealthy for Sensitive', color: '#ff9800', bgColor: 'rgba(255, 152, 0, 0.2)', textColor: '#ff9800'};
          if (aqi <= 200) return { text: 'Unhealthy', color: '#f44336', bgColor: 'rgba(244, 67, 54, 0.2)', textColor: '#f44336'};
          if (aqi <= 300) return { text: 'Very Unhealthy', color: '#9c27b0', bgColor: 'rgba(156, 39, 176, 0.2)', textColor: '#9c27b0'};
          return { text: 'Hazardous', color: '#7E57C2', bgColor: 'rgba(126, 87, 194, 0.2)', textColor: '#7E57C2'};
      }

      function getHealthRecommendations(aqi) {
          if (aqi <= 50) return 'Air quality is excellent. Great day for outdoor activities!';
          if (aqi <= 100) return 'Sensitive individuals should consider limiting prolonged outdoor exertion.';
          if (aqi <= 150) return 'General public, and especially sensitive groups, are at risk. Reduce outdoor activity.';
          if (aqi <= 200) return 'Everyone may experience health effects. Avoid prolonged outdoor exertion.';
          return 'Health alert: everyone may experience more serious health effects. Stay indoors if possible.';
      }

      // --- START THE APP ---
      initializeApp();
    });
  </script>
</body>
</html>
